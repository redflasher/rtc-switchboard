function initialize(){$(".infoMsg2").html("Finding..."),$(".infoMsg2").css("z-index",100),$("[name=mySex]").prop("disabled",!0),$("[name=yourSex]").prop("disabled",!0),$("[name=country]").prop("disabled",!0),$("[name=startChatBtn]").prop("disabled",!0),$("[name=stopChatBtn]").prop("disabled",!1),$("[name=nextChatBtn]").prop("disabled",!1),$(".chatLog").html(""),doGetUserMedia()}function openChannel(e){var n={};n.room="room",n.mySex=$("[name=mySex]").val(),n.yourSex=$("[name=yourSex]").val(),n.country=$("[name=country]").val(),$.ajax({url:PHP_PATH+"getStatus.php",method:"POST",data:n,success:function(n){if(0==n.length)peerType="offer",e("offer");else{var t=JSON.parse(n);t&&(sessionId=JSON.parse(n).sessionId,peerType="answer",remoteSdp.sdp=JSON.parse(n).sdp,remoteSdp.type="offer",e("answer"))}}})}function setOffer(e){var n={};n.room=ROOM,n.mySex=$("[name=mySex]").val(),n.yourSex=$("[name=yourSex]").val(),n.country=$("[name=country]").val(),n.videoKey=e,n.type=peerType,$.ajax({url:PHP_PATH+"setOffer.php",method:"POST",data:n,success:function(e){sessionId=JSON.parse(e).sessionId}})}function setAnswer(e){var n={};n.room=ROOM,n.mySex=$("[name=mySex]").val(),n.yourSex=$("[name=yourSex]").val(),n.country=$("[name=country]").val(),n.videoKey=e,n.type=peerType,n.sessionId=sessionId,$.ajax({url:PHP_PATH+"setOffer.php",method:"POST",data:n,success:function(e){sessionId=JSON.parse(e).sessionId}})}function doGetUserMedia(){var e={mandatory:{},optional:[]};try{getUserMedia({audio:!0,video:e},onUserMediaSuccess,onUserMediaError)}catch(n){alert("getUserMedia() failed. Is this a WebRTC capable browser?")}}function createPeerConnection(){var e={iceServers:[{url:"stun:stun.l.google.com:19302"}]};try{pc&&(pc=null),pc=new window.RTCPeerConnection(e),pc.onicecandidate=onIceCandidate,pc.oniceconnectionstatechange=changeICEState}catch(n){return void alert("Cannot create RTCPeerConnection object; WebRTC is not supported by this browser.")}pc.onconnecting=onSessionConnecting,pc.onopen=onSessionOpened,pc.onaddstream=onRemoteStreamAdded,pc.onremovestream=onRemoteStreamRemoved}function maybeStart(){!started&&localStream&&channelReady&&(setStatus("Connecting..."),createPeerConnection(),pc.addStream(localStream),started=!0,initiator?doCall():doAnswer())}function maybeStart2(){started||(setStatus("Connecting..."),createPeerConnection(),started=!0,initiator?doCall():doAnswer())}function setStatus(e){}function doCall(){pc.createOffer(setLocalAndSendMessage,function(){},mediaConstraints)}function doAnswer(){pc.setRemoteDescription(new RTCSessionDescription(remoteSdp)),pc.createAnswer(setLocalAndSendMessage2,function(){},mediaConstraints)}function setLocalAndSendMessage(e){pc.setLocalDescription(e),sendMessage(e),waitAnswerTimer=setInterval(waitAnswer,1e3)}function waitAnswer(){var e={};e.sessionId=sessionId,$.ajax({url:PHP_PATH+"getAnswer.php",method:"POST",data:e,success:function(e){if(e.length>0){var n=JSON.parse(e);n&&(remoteSdp.sdp=n.sdp,remoteSdp.type="answer",pc.setRemoteDescription(new RTCSessionDescription(remoteSdp)),clearInterval(waitAnswerTimer),getICE())}}})}function setLocalAndSendMessage2(e){pc.setLocalDescription(e),setAnswer(e.sdp),getICE()}function getICE(){var e={};"offer"==peerType?e.type="answer":"answer"==peerType&&(e.type="offer"),e.sessionId=sessionId,$.ajax({url:PHP_PATH+"getCandidates.php",method:"POST",data:e,success:function(e){var n=JSON.parse(e).candidates;return 0==n.length?!1:(n=JSON.parse(n),void $.each(n,function(e,n){var t=window.mozRTCIceCandidate||window.RTCIceCandidate;pc.addIceCandidate(new t(n))}))}})}function changeICEState(){null!=pc&&"disconnected"==pc.iceConnectionState&&(clearInterval(chatGetMessageTimer),$(".chatInput").prop("disabled",!0),$(".chatSendBtn").prop("disabled",!0),remoteVideo.src="",autoReconnect?($(".infoMsg2").html("Companion was disconnected. Finding next.."),$(".infoMsg2").css("z-index",100)):($(".infoMsg2").html("Companion was disconnected. Press Start to try again."),$(".infoMsg2").css("z-index",100)),clearPeer(function(){return started=!1,$("[name=mySex]").prop("disabled",!1),$("[name=yourSex]").prop("disabled",!1),$("[name=country]").prop("disabled",!1),$("[name=startChatBtn]").prop("disabled",!1),$("[name=stopChatBtn]").prop("disabled",!0),autoReconnect?($(".chatLog").html(""),$("[name=mySex]").prop("disabled",!0),$("[name=yourSex]").prop("disabled",!0),$("[name=country]").prop("disabled",!0),$("[name=startChatBtn]").prop("disabled",!0),$("[name=stopChatBtn]").prop("disabled",!1),$("[name=nextChatBtn]").prop("disabled",!1),void openChannel(function(e){"offer"==e?initiator=!0:"answer"==e&&(initiator=!1),maybeStart()})):!1}))}function sendMessage(e){var n=JSON.stringify(e);if("candidates"!=JSON.parse(n).type)return"offer"==JSON.parse(n).type?setOffer(JSON.parse(n).sdp):"answer"==JSON.parse(n).type,!1;var t={};t.sessionId=sessionId,t.candidates=JSON.stringify(JSON.parse(n).data),t.type=peerType,$.ajax({url:PHP_PATH+"setCandidate.php",method:"POST",data:t,success:function(e){}})}function processSignalingMessage(e){var n=JSON.parse(e);if("offer"===n.type)initiator||started||maybeStart(),remoteSdp=n,pc.setRemoteDescription(new RTCSessionDescription(n)),doAnswer();else if("answer"===n.type&&started)pc.setRemoteDescription(new RTCSessionDescription(n));else if("candidate"===n.type&&started){new RTCIceCandidate({sdpMLineIndex:n.label,candidate:n.candidate})}}function onChannelOpened(){channelReady=!0,initiator&&maybeStart()}function onChannelMessage(){$.ajax({url:PHP_PATH+"getStatus.php",method:"POST",success:function(e){sessionId=JSON.parse(e).sessionId}})}function onChannelError(){}function onChannelClosed(){}function onUserMediaSuccess(e){attachMediaStream(localVideo,e),localVideo.style.opacity=1,localStream=e,openChannel(function(e){"offer"==e?initiator=!0:"answer"==e&&(initiator=!1),maybeStart()})}function onUserMediaError(e){getUserMedia({audio:!1,video:!1},function(e){},function(e){}),channelReady=!0,openChannel(function(e){"offer"==e?initiator=!0:"answer"==e&&(initiator=!1),maybeStart2()})}function onIceCandidate(e){e.candidate?candidatesArr.push({type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}):(sendMessage({type:"candidates",data:candidatesArr}),candidatesArr=[])}function onSessionConnecting(e){}function onSessionOpened(e){}function onRemoteStreamAdded(e){enableTextChat(),$(".infoMsg2").css("z-index",0),remoteVideo.src=e.stream,remoteStream=e.stream,attachMediaStream(remoteVideo,e.stream)}function onRemoteStreamRemoved(e){}function clearPeer(e){var n={};n.sessionId=sessionId,n.type=peerType,$.ajax({url:PHP_PATH+"clearPeer.php",method:"POST",data:n,success:function(n){e(n)}})}function preferOpus(e){for(var n=e.split("\r\n"),t=0;t<n.length;t++)if(-1!==n[t].search("m=audio")){var a=t;break}if(null===a)return e;for(var t=0;t<n.length;t++)if(-1!==n[t].search("opus/48000")){var o=extractSdp(n[t],/:(\d+) opus\/48000/i);o&&(n[a]=setDefaultCodec(n[a],o));break}return n=removeCN(n,a),e=n.join("\r\n")}function extractSdp(e,n){var t=e.match(n);return t&&2==t.length?t[1]:null}function setDefaultCodec(e,n){for(var t=e.split(" "),a=new Array,o=0,r=0;r<t.length;r++)3===o&&(a[o++]=n),t[r]!==n&&(a[o++]=t[r]);return a.join(" ")}function removeCN(e,n){for(var t=e[n].split(" "),a=e.length-1;a>=0;a--){var o=extractSdp(e[a],/a=rtpmap:(\d+) CN\/\d+/i);if(o){var r=t.indexOf(o);-1!==r&&t.splice(r,1),e.splice(a,1)}}return e[n]=t.join(" "),e}function changeReconnect(){autoReconnect=$("[name=autoReconnectCheckbox]").is(":checked"),setCookie("autoReconnect",Boolean(autoReconnect))}function stopChat(){remoteVideo.src="",localVideo.src="",$(".infoMsg2").html("Press Start to chat"),$(".infoMsg2").css("z-index",100),clearInterval(chatGetMessageTimer),pc&&(pc.close(),pc=null),$(".chatInput").prop("disabled",!0),$(".chatSendBtn").prop("disabled",!0),clearPeer(function(){started=!1,$("[name=mySex]").prop("disabled",!1),$("[name=yourSex]").prop("disabled",!1),$("[name=country]").prop("disabled",!1),$("[name=startChatBtn]").prop("disabled",!1),$("[name=stopChatBtn]").prop("disabled",!0)})}function nextChat(){remoteVideo.src="",$(".infoMsg2").html("Finding..."),$(".infoMsg2").css("z-index",100),pc&&(pc.close(),pc=null),clearInterval(chatGetMessageTimer),$(".chatInput").prop("disabled",!0),$(".chatSendBtn").prop("disabled",!0),clearPeer(function(){started=!1,$(".chatLog").html(""),openChannel(function(e){"offer"==e?initiator=!0:"answer"==e&&(initiator=!1),maybeStart()})})}function getCookie(e){var n=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return n?decodeURIComponent(n[1]):void 0}function setCookie(e,n,t){t=t||{};var a=t.expires;if("number"==typeof a&&a){var o=new Date;o.setTime(o.getTime()+1e3*a),a=t.expires=o}a&&a.toUTCString&&(t.expires=a.toUTCString()),n=encodeURIComponent(n);var r=e+"="+n;for(var s in t){r+="; "+s;var i=t[s];i!==!0&&(r+="="+i)}document.cookie=r}var waitAnswerTimer,candidatesArr=[];window.onbeforeunload=function(){clearPeer(function(){}),setTimeout(function(){},100)};